<!DOCTYPE html>
<html>
<head>
    <script>
        timeout = seconds(5);
        server = "http://matt:8000/api/experiment/";
        colors = shuffle(["red", "white", "blue"]);


        // Knuth Random Shuffle Algorithm
        function shuffle(array) {
            var currentIndex = array.length, temporaryValue, randomIndex;
            while (0 !== currentIndex) {
              randomIndex = Math.floor(Math.random() * currentIndex);
              currentIndex -= 1;
              temporaryValue = array[currentIndex];
              array[currentIndex] = array[randomIndex];
              array[randomIndex] = temporaryValue;
            }
            return array;
        }

        experiment = {'click':[]};

        function click() {
            experiment['click'].push({
                "datetime": new Date().toJSON(),
                "background": document.body.style.backgroundColor
            });
        }

        function sleep(seconds) {
          return new Promise((resolve) => setTimeout(resolve, seconds));
        }

        function changeColor(arg) {
            var colorIndex = arg.self.substr(-1);
            var color = colors[colorIndex];
            var element = document.getElementById(arg.self);
            var body = document.getElementById('body');

            element.innerHTML = '';
            element.style.backgroundColor = color;
            body.style.backgroundColor = color;

            document.body.addEventListener('click', click);

            sleep(timeout).then(() => {
                document.body.removeEventListener('click', click);
                hide(arg.self);
                show(arg.next);
            });
        }

        function fullscreen() {
            var bg = document.getElementById('body');

            if (bg.webkitRequestFullScreen)
                bg.webkitRequestFullScreen();
            else
                bg.mozRequestFullScreen();
        }

        function hide(id) {
            document.getElementById(id).style.zIndex = -1;
        }

        function show(id) {
            document.getElementById(id).style.zIndex = 1;
        }

        function seconds(number) {
            return number * 1000;
        }

        function start() {
            fullscreen();
            experiment['start_date'] = new Date().toJSON();
            hide('start');
            show('survey');
        }

        function process_survey() {
            for (let field of document.getElementById('form').elements)
                if (field.type == 'radio' && !field.checked || field.type == 'submit')
                    continue;
                else
                    experiment[field.name] = field.value;

            hide('survey');
            show('color0');
        }

        function end() {
            if (! Object.keys(experiment).length)
                return false;

            var now = new Date().toJSON();
            experiment['end_date'] = now;
            localStorage.setItem(now, JSON.stringify(experiment));
            experiment = {};
        }

        function upload() {
            Object.keys(localStorage).forEach(function(key) {
                $.ajax({
                    type: "POST",
                    url: server,
                    crossDomain: true,
                    data: localStorage.getItem(key),

                    success: function(response) {
                        localStorage.removeItem(key);
                    },

                    error: function(response) {
                        console.log(response);
                    }
                });
            });
        }
    </script>

    <script src="jquery-3.1.1.min.js"></script>

	<style>
        #background, section { height: 100%; width: 100%; position: absolute; left: 0; top: 0; padding: 1em; color: #fff; font-family: sans-serif; line-height: 1.5em; }

        #background { background: url('background.jpg') center center fixed; z-index: 0; background-size: cover; }
        #survey li { list-style: none; }

        #start        { z-index: 1; }
        #survey       { z-index: -1; }
        #test         { z-index: -1; }
        #color0       { z-index: -1; }
        #color1       { z-index: -1; }
        #color2       { z-index: -1; }
        #end          { z-index: -1; }
	</style>
</head>

<body id="body">
    <div id="background"></div>
    <section id="start">
    	<h1>Subjective Time Perception Experiment</h1>

    	<h2>Objective</h2>
    	<p>The purpose of this experiment is to measure how different colors incluence on time perception</p>

    	<h2>Length</h2>
    	<p>The experiment takes around 5 minutes.</p>

        <h2>Instructions</h2>
        <ol>
            <li>Click start and the experiment will enter fullscreen.</li>
            <li>Fill short survey.</li>
            <li>We will try three colors (red, blue, white) each for 30 seconds.</li>
            <li>You'll be warned each time color is about to change.</li>
    		<li>During the experiment click the left mouse button trying to achieve a regular tempo of <strong>one click per second</strong>.</li>
            <li>The colors order will be randomized on each experiment.</li>
            <li>If you want to exit experiment before time, simply click '<strong>ESC</strong>' key on your keyboard.</li>
        </ol>
        <button onclick="start()">Proceed to the survey</button>
    </section>

    <section id="survey">
        <h1>User Survey</h1>

        <form id="form" action="#" method="GET" onsubmit="process_survey(); return false">

        <input type="text" name="first_name" placeholder="First Name" required="required" maxlength="50" pattern="[A-Za-z]{2,50}" />
        <input type="text" name="last_name" placeholder="Last Name" required="required" maxlength="50" pattern="[A-Za-z]{2,50}" />

        <input type="number" placeholder="Age" name="age" min="1" max="150" required="required" />

        <h2>What is your gender?</h2>
        <ul>
            <li><input type="radio" name="gender" value="male" required="required" /> Male</li>
            <li><input type="radio" name="gender" value="female" required="required" /> Female</li>
            <li><input type="radio" name="gender" value="other" required="required" /> Other</li>
        </ul>

        <h2>How do you feel?</h2>
        <ul>
            <li><input type="radio" name="condition" value="well rested" required="required" /> Well rested</li>
            <li><input type="radio" name="condition" value="normal" required="required" /> Normal</li>
            <li><input type="radio" name="condition" value="tired" required="required" /> Tired</li>
        </ul>

        <h2>What is your sense of rhythm?</h2>
        <ul>
            <li><input type="radio" name="rhythm" value="perfect" required="required" /> Perfect</li>
            <li><input type="radio" name="rhythm" value="above average" required="required" /> Above average</li>
            <li><input type="radio" name="rhythm" value="average" required="required" /> Average</li>
            <li><input type="radio" name="rhythm" value="below average" required="required" /> Below average</li>
            <li><input type="radio" name="rhythm" value="poor" required="required" /> Poor</li>
        </ul>
        <input type="submit" value="Start Test" /></button>
        </form>
    </section>

    <section id="test">
        <h1>You may now proceed to test section</h1>
        <p>On the following screen click the left mouse button trying to achieve a regular tempo of <strong>one click per second</strong>.</p>
        <button onclick="">Test!</button>
    </section>

    <section id="color0">
        <h1>You will see the first color now</h1>
        <p>Please try to click once per seconds.</p>
        <button onclick="changeColor({self: 'color0', next: 'color1'});">OK, go!</button>
    </section>

    <section id="color1">
        <h1>You will see the second color now</h1>
        <p>Please try to click once per seconds.</p>
        <button onclick="changeColor({self: 'color1', next: 'color2'});">OK, go!</button>
    </section>

    <section id="color2">
        <h1>You will see the third color now</h1>
        <p>Please try to click once per seconds.</p>
        <button onclick="changeColor({self: 'color2', next: 'end'});">OK, go!</button>
    </section>

    <section id="end">
        <h1>Thank you for participation in the research</h1>
        <button onclick="end(); location.reload()">Save results and run another experiment</button>
        <button onclick="end(); upload()">Upload results to database</button>
    </section>
</body>
</html>
