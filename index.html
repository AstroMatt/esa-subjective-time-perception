<!DOCTYPE html>
<html>
<head>
	<style>
        section { background: white; height: 100%; width: 100%; position: absolute; left: 0; top: 0; padding: 1em; }

        #survey li { list-style: none; }

        #start        { z-index: 1; }
        #survey       { z-index: 0; }
        #color0       { z-index: 0; }
        #color1       { z-index: 0; }
        #color2       { z-index: 0; }
        #end          { z-index: 0; }
	</style>

	<script>
        var colors = shuffle(["red", "white", "blue"]);

        var log = {
            data: function(data) {
                log.add({
                    "datetime": new Date().toJSON(),
                    "type": 'data',
                    "values": data
                });
            },

            text: function(message) {
                log.add({
                    "datetime": new Date().toJSON(),
                    "type": 'text',
                    "values": {"text": message}
                });
            },

            event: function(msg) {
                log.add({
                    "datetime": new Date().toJSON(),
                    "type": 'event',
                    'values': {
                        "event": 'User clicked mouse',
                        'backgroundColor': document.body.style.backgroundColor
                    }
                });
            },

            add: function(entry) {
                console.log(entry);
                localStorage.setItem(new Date().toJSON(), JSON.stringify(entry));
            },

            show: function() {
                var list = document.getElementById('logs');
                list.innerHTML = '';

                Object.keys(localStorage).forEach(function(key){
                    var message = localStorage.getItem(key);
                    var li = document.createElement("li");
                    li.appendChild(document.createTextNode(message));
                    list.appendChild(li);
                });
            },

            sync: function() {
                Object.keys(localStorage).forEach(function(key){

                });
            }
        }

        function shuffle(array) {
            var currentIndex = array.length, temporaryValue, randomIndex;

            // While there remain elements to shuffle...
            while (0 !== currentIndex) {

              // Pick a remaining element...
              randomIndex = Math.floor(Math.random() * currentIndex);
              currentIndex -= 1;

              // And swap it with the current element.
              temporaryValue = array[currentIndex];
              array[currentIndex] = array[randomIndex];
              array[randomIndex] = temporaryValue;
            }
            return array;
        }

        function sleep(seconds) {
          return new Promise((resolve) => setTimeout(resolve, seconds));
        }

        function changeColor(arg) {
            var colorIndex = arg.self.substr(-1);
            var color = colors[colorIndex];
            var element = document.getElementById(arg.self);
            var body = document.getElementById('body');

            element.innerHTML = '';
            element.style.backgroundColor = color;
            body.style.backgroundColor = color;

            document.body.addEventListener('click', log.event);

            sleep(arg.timeout).then(() => {
                document.body.removeEventListener('click', log.event);
                hide(arg.self);
                show(arg.next);
            });
        }

        function fullscreen() {
            var bg = document.getElementById('body');

            if (bg.webkitRequestFullScreen)
                bg.webkitRequestFullScreen();
            else
                bg.mozRequestFullScreen();
        }

        function hide(id) {
            document.getElementById(id).style.zIndex = 0;
        }

        function show(id) {
            document.getElementById(id).style.zIndex = 1;
        }

        function seconds(number) {
            return number * 1000;
        }

        function saveForm() {
            for (let field of document.getElementById('form').elements) {

                if (field.type == 'radio' && !field.checked)
                    continue;

                log.data({key: field.name, value: field.value});
            }
        }
    </script>
</head>

<body id="body">
    <section id="start">
    	<h1>Subjective Time Perception Experiment</h1>

    	<h2>Objective</h2>
    	<p>The purpose of this experiment is to measure how different colors incluence on time perception</p>

    	<h2>Length</h2>
    	<p>The experiment takes around 5 minutes.</p>

        <h1>Instructions</h2>
        <ol>
            <li>Click start and the experiment will enter fullscreen.</li>
            <li>Fill short survey.</li>
            <li>We will try three colors (red, blue, white) each for 120 seconds.</li>
            <li>You'll be warned each time color is about to change.</li>
    		<li>During the experiment click the left mouse button trying to achieve a tempo of <strong>one click per second</strong>.</li>
            <li>The colors order will be randomized on each experiment.</li>
            <li>If you want to exit experiment before time, simply click '<strong>ESC</strong>' key on your keyboard.</li>
        </ol>

    	<h2>To Do</h2>
    	<ul>
    		<li>Make background color change every 120 seconds (currently for development the time is 1 seconds)</li>
            <li>Save results to local database (indexeddb or localstorage)</li>
    		<li>Sync local database wtih remote database server (mongo)</li>
    	</ul>
        <button onclick="fullscreen(); log.text('Experiment start'); hide('start'); show('survey');">Run the experiment</button>
    </section>

    <section id="survey">
        <h1>User Survey</h1>

        <form id="form" action="#" method="GET" onsubmit="saveForm(); hide('survey'); show('color0'); return false;">

        <input type="text" name="first_name" placeholder="First Name" required="required" />
        <input type="text" name="last_name" placeholder="Last Name" required="required" />


        <input type="number" placeholder="Age" name="age" min="1" max="150" required="required" />

        <h2>What is your gender?</h2>
        <ul>
            <li><input type="radio" name="gender" value="male" required="required" /> Male</li>
            <li><input type="radio" name="gender" value="female" required="required" /> Female</li>
            <li><input type="radio" name="gender" value="other" required="required" /> Other</li>
        </ul>

        <h2>How do you feel?</h2>
        <ul>
            <li><input type="radio" name="condition" value="well rested" required="required" /> Well rested</li>
            <li><input type="radio" name="condition" value="normal" required="required" /> Normal</li>
            <li><input type="radio" name="condition" value="tired" required="required" /> Tired</li>
        </ul>

        <h2>What is your sense of rhythm?</h2>
        <ul>
            <li><input type="radio" name="senseOfRhythm" value="perfect" required="required" /> Perfect</li>
            <li><input type="radio" name="senseOfRhythm" value="above average" required="required" /> Above average</li>
            <li><input type="radio" name="senseOfRhythm" value="average" required="required" /> Average</li>
            <li><input type="radio" name="senseOfRhythm" value="below average" required="required" /> Below average</li>
            <li><input type="radio" name="senseOfRhythm" value="poor" required="required" /> Poor</li>
        </ul>
        <input type="submit" value="Start Experiment" /></button>
        </form>
    </section>

    <section id="color0">
        <h1>You will see the first color now</h1>
        <button onclick="changeColor({self: 'color0', timeout: seconds(1), next: 'color1'});">OK, go!</button>
    </section>

    <section id="color1">
        <h1>You will see the second color now</h1>
        <button onclick="changeColor({self: 'color1', timeout: seconds(1), next: 'color2'});">OK, go!</button>
    </section>

    <section id="color2">
        <h1>You will see the third color now</h1>
        <button onclick="changeColor({self: 'color2', timeout: seconds(1), next: 'end'});">OK, go!</button>
    </section>

    <section id="end">
        <h1>Thank you for participation in the research</h1>
        <button onclick="log.text('Experiment end'); log.show()">Show logs</button>
        <button onclick="log.save()">Save logs to database</button>
        <ol id="logs"></ol>
    </section>
</body>
</html>
